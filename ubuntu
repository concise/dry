#!/bin/bash

test "${BASH_SOURCE[0]}" = "$0" || {
    echo "Error: '${BASH_SOURCE[0]}' should not be sourced"
    return 1
}

set -o pipefail         # proper status code for a pipeline
set -o errexit          # -e exit when seeing a nonzero status code
set -o nounset          # -u using unbound variable is an error
shopt -s failglob       # pathname expansion failing is an error

__my_exit_trap__ () {
    local LAST_STATUS=$? LAST_COMMAND="$BASH_COMMAND"
    if [[ $LAST_STATUS != 0 ]]
    then
        printf '\nCommand `%s` has nonzero exit status.\n\n' "$LAST_COMMAND"
    fi
}
trap __my_exit_trap__ EXIT

##############################################################################

test -n "$BASH_VERSION"
grep -q 'Ubuntu 16.04' /etc/issue
test "$(id -u)" = 0
wget -q -O /dev/null https://duckduckgo.com/

##############################################################################

timedatectl set-timezone Asia/Taipei

##############################################################################

mv /etc/apt/sources.list /etc/apt/sources.list.bak."$(date +%Y%m%d.%H%M%S)"

#MIRROR=http://archive.ubuntu.com/ubuntu/
#MIRROR=http://mirrors.digitalocean.com/ubuntu/
#MIRROR=http://mirrors.linode.com/ubuntu/
#MIRROR=http://security.ubuntu.com/ubuntu/
#MIRROR=http://tw.archive.ubuntu.com/ubuntu/
#MIRROR=http://us.archive.ubuntu.com/ubuntu/
MIRROR=http://free.nchc.org.tw/ubuntu/

grep -q 'Ubuntu 16.04' /etc/issue && echo "
deb $MIRROR xenial           main restricted universe multiverse
deb $MIRROR xenial-updates   main restricted universe multiverse
deb $MIRROR xenial-backports main restricted universe multiverse
deb $MIRROR xenial-security  main restricted universe multiverse
# deb-src $MIRROR xenial           main restricted universe multiverse
# deb-src $MIRROR xenial-updates   main restricted universe multiverse
# deb-src $MIRROR xenial-backports main restricted universe multiverse
# deb-src $MIRROR xenial-security  main restricted universe multiverse
" > /etc/apt/sources.list

##############################################################################

apt update
apt full-upgrade -y
apt autoremove -y
apt install -y build-essential exuberant-ctags gdb git gnupg2 htop mosh openssh-server screen tig tmux valgrind vim python3 python3-venv python3-dev

##############################################################################

mv /etc/vim/vimrc /etc/vim/vimrc.bak."$(date +%Y%m%d.%H%M%S)"
echo > /etc/vim/vimrc 'se nocp uc=0 vi= nolpl rtp=$VIMRUNTIME mls=0 hid bs=2 ai ci pi et sts=4 sw=4 kp=:help fo=qn tw=79 sc shm+=I lcs=tab:>-,trail:.|sy off|filet off'
update-alternatives --set editor /usr/bin/vim.basic
echo > /etc/profile.d/my_selected_editor.sh 'export SELECTED_EDITOR=/usr/bin/vim.basic'

##############################################################################

cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak."$(date +%Y%m%d.%H%M%S)"
sed -i 's@^PermitRootLogin.*$@PermitRootLogin yes@' /etc/ssh/sshd_config
if ! grep -q 'UseDNS' /etc/ssh/sshd_config
then
    echo 'UseDNS no' >> /etc/ssh/sshd_config
fi
service ssh restart

##############################################################################

#if dpkg -l ubuntu-desktop &> /dev/null
#then
#    cp /etc/default/keyboard /etc/default/keyboard.bak."$(date +%Y%m%d.%H%M%S)"
#    sed -i 's@^XKBOPTIONS=.*$@XKBOPTIONS="ctrl:nocaps"@' /etc/default/keyboard
#    dpkg-reconfigure --priority=high keyboard-configuration
#fi

cp /etc/default/keyboard /etc/default/keyboard.bak."$(date +%Y%m%d.%H%M%S)"
sed -i 's@^XKBOPTIONS=.*$@XKBOPTIONS="ctrl:nocaps"@' /etc/default/keyboard
dpkg-reconfigure --priority=high keyboard-configuration
